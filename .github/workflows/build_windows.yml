name: ğŸ–¥ Build Windows EXE - Fletube

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1
      SECRET: ${{ secrets.SECRET }}
      EMAIL_USER: ${{ secrets.EMAIL_USER }}
      EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
      SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
      SMTP_PORT: ${{ secrets.SMTP_PORT }}
      FEEDBACK_RECIPIENT_EMAIL: ${{ secrets.FEEDBACK_RECIPIENT_EMAIL }}
      SUPABASE_URL_USERS: ${{ secrets.SUPABASE_URL_USERS }}
      SUPABASE_KEY_USERS: ${{ secrets.SUPABASE_KEY_USERS }}

    steps:
    - name: ğŸ§¾ Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13.3'

    - name: ğŸ“¦ Instalar dependÃªncias do projeto
      run: |
        pip install --upgrade pip
        pip install flet==0.28.3 python-dotenv requests yt-dlp

    - name: âœ… Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.29.2'
        channel: stable

    - name: ğŸ” VerificaÃ§Ã£o do Flutter
      run: flutter doctor -v

    - name: ğŸ” Criar arquivo .env para o build
      run: |
        echo "SECRET=$env:SECRET" > .env
        echo "EMAIL_USER=$env:EMAIL_USER" >> .env
        echo "EMAIL_PASSWORD=$env:EMAIL_PASSWORD" >> .env
        echo "SMTP_SERVER=$env:SMTP_SERVER" >> .env
        echo "SMTP_PORT=$env:SMTP_PORT" >> .env
        echo "FEEDBACK_RECIPIENT_EMAIL=$env:FEEDBACK_RECIPIENT_EMAIL" >> .env
        echo "SUPABASE_URL_USERS=$env:SUPABASE_URL_USERS" >> .env
        echo "SUPABASE_KEY_USERS=$env:SUPABASE_KEY_USERS" >> .env

    - name: ğŸ“¸ Garantir variÃ¡veis no ambiente de build
      run: |
        echo "ğŸ“¸ SECRET definida: $(if ($env:SECRET) { 'âœ…' } else { 'âŒ' })"
        echo "ğŸ“¸ EMAIL_USER definida: $(if ($env:EMAIL_USER) { 'âœ…' } else { 'âŒ' })"
        echo "ğŸ“¸ SMTP_SERVER definida: $(if ($env:SMTP_SERVER) { 'âœ…' } else { 'âŒ' })"
      shell: pwsh

    - name: ğŸ“ Verificar estrutura de arquivos
      run: |
        echo "ğŸ“‚ Verificando estrutura do projeto:"
        Get-ChildItem
        echo ""
        echo "ğŸ“„ Verificando pyproject.toml:"
        Get-Content pyproject.toml
        echo ""
        echo "ğŸ¨ Verificando pasta assets:"
        if (Test-Path assets) { Get-ChildItem assets } else { echo "Pasta assets nÃ£o encontrada" }
      shell: pwsh

    - name: ğŸš€ Build Windows EXE com Flet (usando pyproject.toml)
      run: |
        flet build windows `
          --compile-app `
          --splash-color "#0A1A2F" `
          --splash-dark-color "#0A1A2F" `
          -vv

    - name: ğŸ“‹ Mostrar arquivos gerados
      run: |
        echo "ğŸ“¦ Estrutura do build:"
        if (Test-Path build) { 
          Get-ChildItem -Recurse build 
        } else { 
          echo "Pasta build nÃ£o encontrada" 
        }
        
        echo ""
        echo "ğŸ–± EXE gerado:"
        Get-ChildItem -Recurse -Filter *.exe -ErrorAction SilentlyContinue | Select-Object FullName, @{Name="Size";Expression={"{0:N2} MB" -f ($_.Length / 1MB)}}
      shell: pwsh

    - name: ğŸ“¤ Upload do EXE
      uses: actions/upload-artifact@v4
      with:
        name: exe-fletube-${{ github.sha }}
        path: |
          build/windows/**/*.exe
          dist/*.exe
        retention-days: 30

    - name: âœ… Finalizado!
      run: echo "âœ¨ EXE gerado com sucesso! Verifique na aba Actions â†’ Artifacts"